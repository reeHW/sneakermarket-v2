<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout/basic">
<th:block layout:fragment="title">
    <title>리스트 페이지</title>
</th:block>

<th:block layout:fragment="content">
    <div class="page_tits">
        <h3>게시판</h3>
        <p class="path"><strong>현재 위치 :</strong> <span>게시판 관리</span> <span>리스트형</span> <span>리스트</span></p>
    </div>

    <div class="content">
        <section>
            <!--/* 검색 */-->
            <div class="search_box">
                <form id="searchForm" onsubmit="return false;" autocomplete="off">
                    <div class="sch_group fl">
                        <select id="searchType" title="검색 유형 선택">
                            <option value="">전체 검색</option>
                            <option value="">제목</option>
                            <option value="">내용</option>
                        </select>
                        <input type="text" id="keyword" placeholder="키워드를 입력해 주세요." title="키워드 입력"/>
                        <button type="button" onclick="findAll(1);" class="bt_search"><i class="fas fa-search"></i><span class="skip_info">검색</span></button>
                    </div>
                </form>
            </div>

            <!--/* 리스트 */-->
            <table class="tb tb_col">
                <colgroup>
                    <col style="width:7.5%;"/><col style="width:auto;"/><col style="width:10%;"/><col style="width:10%;"/><col style="width:15%;"/><col style="width:7.5%;"/>
                </colgroup>
                <thead>
                <tr>
                    <th scope="col">번호</th>
                    <th scope="col">제목</th>
                    <th scope="col">작성자</th>
                    <th scope="col">판매상태</th>
                    <th scope="col">등록일</th>
                    <th scope="col">조회</th>
                </tr>
                </thead>
                <!-- /*게시글 리스트 렌더링 영역*/ -->
                <tbody id ="list">

                </tbody>
            </table>

            <!--/* 페이지네이션 */-->
            <div class="paging">

            </div>

            <!--/* 버튼 */-->
            <p class="btn_set tr">
                <a th:href="@{/post/write}" class="btns btn_st3 btn_mid">글쓰기</a>
            </p>
        </section>
    </div> <!--/* .content */-->
</th:block>
<th:block layout:fragment="script">
    <script th:inline="javascript">
        /*<![CDATA{*/

        /**
         * 페이지 로딩 시점에 실행되는 함수
         */
        window.onload = () => {

            findAll(1);
            addEnterSearchEvent();
        }

        /**
         * 키워드 - 엔터 검색 이벤트 바인딩
         */
        function addEnterSearchEvent() {

            document.getElementById('keyword').addEventListener('keyup', (e) => {
                if (e.keyCode === 13) {
                    findAll(1);
                }
            });
        }

        /**
         * 조회 API 호출
         */
        async function getJson(uri, params) {

            if (params) {
                uri = uri + '?' + new URLSearchParams(params).toString();
            }

            const response = await fetch(uri);

            if (!response.ok) {
                await response.json().then(error => {
                    throw error;
                });
            }

            return await response.json();
        }

        /**
         * 게시글 리스트 조회
         */
        function findAll(page) {

            const form = document.getElementById('searchForm');
            const params = {
                page: page
                , recordSize: 10
                , pageSize: 10
                , searchType: form.searchType.value
                , keyword: form.keyword.value
            }

            getJson('/api/posts', params).then(response => {
                if (!Object.keys(response).length) {
                    document.getElementById('list').innerHTML = '<td colspan="5">등록된 게시글이 없습니다.</td>';
                    drawPages();
                    return false;
                }

                let html = '';
                let num = response.params.pagination.totalRecordCount - ((response.params.page - 1) * response.params.recordSize);

                response.list.forEach((obj, idx) => {
                    html += `
							<tr>
    							<td>${num--}</td>
    							<td class="tl">
    								<a href="javascript: void(0);" onclick="goView(${obj.id})">${obj.title}</a>
    							</td>
    							<td>${obj.writer}</td>
    							<td>${obj.saleStatus.value}</td>
    							<td>${dayjs(obj.createdDate).format('YYYY-MM-DD HH:mm:ss')}</td>
    							<td>${obj.viewCnt}</td>

							</tr>
						`;

                });

                document.getElementById('list').innerHTML = html;
                drawPages(response.params);

            });
        }

        /**
         * 게시글 조회
         */
        function goView(id) {
            location.href = `/post/view/${id}`;
        }

        /**
         * 페이지 HTML 렌더링
         */
            function drawPages(params) {

            if (!params) {
            document.querySelector('.pagination').innerHTML = '';
            return false;
        }

            let html = '';
            const pagination = params.pagination;

            // 첫 페이지, 이전 페이지
            if (pagination.existPrevPage) {
            html += `
 				<a href="javascript:void(0)" onclick="findAll(1);" aria-label="Previous"><span aria-hidden="true">«</span></a>
 				<a href="javascript:void(0)" onclick="findAll(${pagination.startPage - 1});" aria-label="Previous"><span aria-hidden="true">‹</span></a>
 			`;
        }

            /*
              * 4. 시작 페이지(startPage)와 끝 페이지(endPage) 사이의 페이지 번호(i)를 넘버링 하는 로직
              *    페이지 번호(i)와 현재 페이지 번호(params.page)가 동일한 경우, 페이지 번호(i)를 활성화(on) 처리
              */
            html += '<p>';
            for (let i = pagination.startPage; i <= pagination.endPage; i++) {
                html += (i !== params.page)
                    ? `<a href="javascript:void(0);" onclick="movePage(${i});">${i}</a>`
                    : `<span class="on">${i}</span>`
            }
            html += '</p>';

            // 다음 페이지, 마지막 페이지
            if (pagination.existNextPage) {
            html += `
 				<a href="javascript:void(0)" onclick="findAll(${pagination.endPage + 1});" aria-label="Next"><span aria-hidden="true">›</span></a>
 				<a href="javascript:void(0)" onclick="findAll(${pagination.totalPageCount});" aria-label="Next"><span aria-hidden="true">»</span></a>
 			`;
        }

            document.querySelector('.paging').innerHTML = html;
        }

            /*]]>*/
    </script>
</th:block>
</html>

